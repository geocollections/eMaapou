<template>
  <detail>
    <template #title>
      <title-card-detail
        :ids="ids"
        :title="$translate({ et: site.name, en: site.name_en })"
        class="title-site"
      />
    </template>

    <template #column-left>
      <v-card-title class="subsection-title">{{
        $t('common.general')
      }}</v-card-title>
      <v-card-text>
        <v-simple-table dense class="custom-table">
          <template #default>
            <tbody>
              <data-row
                :title="$t('site.name')"
                :value="
                  $translate({
                    et: site.name,
                    en: site.name_en,
                  })
                "
              />
              <data-row
                v-if="site.area"
                :value="site.area"
                :title="$t('site.area')"
              >
                <template #value>
                  <a
                    v-if="site.area__area_type === 2"
                    class="text-link"
                    @click="$openTurba('turbaala', site.area)"
                  >
                    {{
                      $translate({
                        et: site.area__name,
                        en: site.area__name_en,
                      })
                    }}
                    <v-icon small color="primary darken-2"
                      >mdi-open-in-new</v-icon
                    >
                  </a>
                  <div v-else>
                    {{
                      $translate({
                        et: site.area__name,
                        en: site.area__name_en,
                      })
                    }}
                  </div>
                </template>
              </data-row>

              <data-row
                v-if="site.area__area_type === 2"
                :value="site.area"
                :title="$t('site.areaText1')"
              >
                <template #value>
                  <span v-for="(item, index) in planArray" :key="index">
                    <a
                      class="text-link"
                      :download="item.trim()"
                      @click="$openTurba('plaanid', item.trim(), false)"
                    >
                      {{ item }}
                      <v-icon small color="primary darken-2"
                        >mdi-file-download-outline</v-icon
                      >
                    </a>
                    <span v-if="index !== planArray.length - 1" class="mr-1"
                      >|</span
                    >
                  </span>
                </template>
              </data-row>
              <data-row
                :title="$t('site.project')"
                :value="
                  $translate({
                    et: site.project__name,
                    en: site.project__name_en,
                  })
                "
              />
              <data-row :title="$t('site.coordx')" :value="site.coordx" />
              <data-row :title="$t('site.coordy')" :value="site.coordy" />
              <data-row :title="$t('site.extent')" :value="site.extent" />
              <data-row :title="$t('site.depth')" :value="site.depth" />

              <link-data-row
                v-if="(site.latitude && site.longitude) || site.locality_id"
                :title="$t('locality.locality')"
                :value="
                  $translate({
                    et: site.locality__locality,
                    en: site.locality__locality_en,
                  })
                "
                nuxt
                :href="
                  localePath({
                    name: 'locality-id',
                    params: { id: site.locality_id },
                  })
                "
              />
              <data-row
                v-if="site.locality_id"
                :title="$t('locality.country')"
                :value="
                  isNil(
                    $translate({
                      et: site.locality__country__value,
                      en: site.locality__country__value_en,
                    })
                  )
                "
              >
                <template #value>
                  {{
                    $t('locality.countryFormat', {
                      name: $translate({
                        et: site.locality__country__value,
                        en: site.locality__country__value_en,
                      }),
                      iso: site.locality__country__iso_code,
                    })
                  }}
                </template>
              </data-row>
              <!-- ???: What is this if statment? Why does this element have to be shown when there is a locality id?  -->
              <data-row
                v-if="(site.latitude && site.longitude) || site.locality_id"
                :title="$t('locality.latitude')"
                :value="site.latitude"
              />
              <data-row
                v-if="(site.latitude && site.longitude) || site.locality_id"
                :title="$t('locality.longitude')"
                :value="site.longitude"
              />
              <data-row
                v-if="elevation"
                :title="$t('site.elevation')"
                :value="elevation"
              />
              <data-row
                v-if="site.locality__depth"
                :title="$t('locality.depth')"
                :value="site.locality__depth"
              />
              <data-row
                v-if="site.location_accuracy"
                :title="$t('site.locationAccuracy')"
                :value="site.location_accuracy"
              />
              <data-row
                v-if="site.coord_det_method"
                :title="$t('site.coordDetMethod')"
                :value="
                  $translate({
                    et: site.coord_det_method__value,
                    en: site.coord_det_method__value_en,
                  })
                "
              />
              <data-row
                :title="$t('site.description')"
                :value="site.description"
              />
              <data-row
                v-if="site.remarks"
                :title="$t('site.remarks')"
                :value="site.remarks"
              />
              <data-row
                v-if="site.remarks_location"
                :title="$t('site.remarksLocation')"
                :value="site.remarks_location"
              />
              <data-row
                v-if="studied"
                :title="$t('site.studied')"
                :value="studied"
              />
              <data-row
                v-if="site.date_added"
                :title="$t('site.dateAdded')"
                :value="$formatDate(site.date_added)"
              />
              <data-row
                v-if="site.date_changed"
                :title="$t('site.dateChanged')"
                :value="$formatDate(site.date_changed)"
              />
            </tbody>
          </template>
        </v-simple-table>
      </v-card-text>
    </template>

    <template
      v-if="(site.latitude && site.longitude) || site.locality_id"
      #column-right
    >
      <v-card-text>
        <v-card
          v-if="site.latitude && site.longitude"
          id="map-wrap"
          elevation="0"
        >
          <leaflet-map
            rounded
            :estonian-map="site.locality__country__value === 'Eesti'"
            :estonian-bedrock-overlay="
              site.locality__country__value === 'Eesti'
            "
            site-overlay
            :center="{
              latitude: site.latitude,
              longitude: site.longitude,
            }"
            :markers="[
              {
                latitude: site.latitude,
                longitude: site.longitude,
                text: $translate({
                  et: site.name,
                  en: site.name_en,
                }),
              },
            ]"
          />
        </v-card>
      </v-card-text>
    </template>

    <template #bottom>
      <image-bar v-if="images.length > 0" class="mt-4" :images="images">
        <template #image="{ item, on, attrs }">
          <v-hover v-slot="{ hover }">
            <v-img
              v-bind="attrs"
              :src="`https://files.geocollections.info/small/${item.attachment__uuid_filename}`"
              :lazy-src="`https://files.geocollections.info/small/${item.attachment__uuid_filename}`"
              max-width="200"
              max-height="200"
              width="200"
              height="200"
              :class="{
                'elevation-4': hover,
                'elevation-2': !hover,
              }"
              class="grey lighten-2 rounded transition-swing cursor-pointer"
              v-on="on"
              @click="
                $router.push(
                  localePath({
                    name: 'file-id',
                    params: { id: item.attachment },
                  })
                )
              "
            >
              <template #placeholder>
                <v-row class="fill-height ma-0" align="center" justify="center">
                  <v-progress-circular
                    indeterminate
                    color="grey lighten-5"
                  ></v-progress-circular>
                </v-row>
              </template>
            </v-img>
          </v-hover>
        </template>
        <template #info="{ item }">
          <div v-if="item.attachment__author__agent">
            <span class="font-weight-bold"
              >{{ $t('attachment.author') }}:
            </span>
            <span>{{ item.attachment__author__agent }}</span>
          </div>
          <div
            v-if="
              item.attachment__date_created ||
              item.attachment__date_created_free
            "
          >
            <span class="font-weight-bold">{{ $t('locality.date') }}: </span>
            <span v-if="item.attachment__date_created">
              {{ $formatDate(item.attachment__date_created) }}
            </span>
            <span v-else>{{ item.attachment__date_created_free }}</span>
          </div>
          <div v-else>{{ $t('common.clickToOpen') }}</div>
        </template>
      </image-bar>
      <v-card v-if="filteredTabs.length > 0" class="mt-4 mb-4">
        <tabs :tabs="filteredTabs" :init-active-tab="initActiveTab" />
      </v-card>
    </template>
  </detail>
</template>

<script>
import { isNil } from 'lodash'
import LeafletMap from '@/components/map/LeafletMap'
import TitleCardDetail from '@/components/TitleCardDetail'
import Tabs from '~/components/Tabs.vue'
import DataRow from '~/components/DataRow.vue'
import LinkDataRow from '~/components/LinkDataRow.vue'
import Detail from '~/components/templates/Detail.vue'
import ImageBar from '~/components/ImageBar.vue'

export default {
  components: {
    TitleCardDetail,
    Tabs,
    LeafletMap,
    DataRow,
    LinkDataRow,
    Detail,
    ImageBar,
  },
  async asyncData({ params, route, error, app, redirect }) {
    try {
      const detailViewResponse = await app.$services.sarvREST.getResource(
        'site',
        params.id
      )
      const ids = detailViewResponse?.ids
      const site = detailViewResponse.results[0]

      const tabs = [
        {
          id: 'attachment_link',
          routeName: 'site-id',
          title: 'site.attachments',
          count: 0,
          props: {},
        },
        {
          id: 'sample',
          isSolr: true,
          routeName: 'site-id-samples',
          title: 'site.samples',
          count: 0,
          props: {},
        },
        {
          id: 'locality_description',
          routeName: 'site-id-descriptions',
          title: 'site.localityDescriptions',
          count: 0,
          props: {},
        },
        {
          id: 'locality_reference',
          routeName: 'site-id-references',
          title: 'site.localityReferences',
          count: 0,
          props: {},
        },
      ]

      const attachmentResponse = await app.$services.sarvREST.getResourceList(
        'attachment_link',
        {
          isValid: isNil(site.id),
          defaultParams: {
            site: site.id,
            or_search:
              'attachment__attachment_format__value__startswith:image;attachment__uuid_filename__endswith:jpg;attachment__uuid_filename__endswith:png',
          },
          queryFields: {},
        }
      )
      const attachments = attachmentResponse.items ?? []

      const hydratedTabs = (
        await Promise.all(
          tabs.map(
            async (tab) =>
              await app.$hydrateCount(tab, {
                solr: { default: { fq: `site_id:${site.id}` } },
                api: { default: { site: site.id } },
              })
          )
        )
      ).map((tab) =>
        app.$populateProps(tab, {
          ...tab.props,
          site: site.id,
        })
      )

      const validPath = app.$validateTabRoute(route, hydratedTabs)
      if (validPath !== route.path) redirect(validPath)

      return {
        site,
        ids,
        initActiveTab: validPath,
        tabs: hydratedTabs,
        images: attachments,
      }
    } catch (err) {
      error({
        message: `Could not find site ${route.params.id}`,
        path: route.path,
      })
    }
  },
  head() {
    return {
      title: this.title,
      meta: [
        {
          property: 'og:title',
          hid: 'og:title',
          content: this.title,
        },
      ],
    }
  },
  computed: {
    title() {
      return this.$translate({ et: this.site.name, en: this.site.name_en })
    },
    filteredTabs() {
      return this.tabs.filter((item) => item.count > 0)
    },
    planArray() {
      if (this.site.area__text1) {
        if (this.site.area__text1.includes(',')) {
          return this.site.area__text1.split(',')
        } else return [this.site.area__text1]
      } else return []
    },
    routeName() {
      return this.getRouteBaseName().split('-id')[0]
    },
    elevation() {
      if (this.site.elevation_accuracy) {
        return `${this.site.elevation} (± ${this.site.elevation_accuracy})`
      }
      return this.site.elevation
    },
    studied() {
      if (this.site.date_start) return this.$formatDate(this.site.date_start)
      return this.site.date_free
    },
  },
  methods: {
    isNil,
  },
}
</script>
